# sync_music - Sync music library to external device
# Copyright (C) 2013-2015 Christian Fetzer
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

# Jenkins Job Builder configuration file

# ----- Defaults --------------------------------------------------------------

- defaults:
    name: global
    project-type: freestyle
    concurrent: true
    logrotate:
        numToKeep: 10
    properties:
        - sidebar:
            url: lastCompletedBuild/testReport
            text: Test Result
            icon: images/24x24/clipboard.png
    wrappers:
        - ansicolor
        - timestamps


# ----- SCM -------------------------------------------------------------------

- scm:
    name: scm-git
    scm:
        - git:
            url: ssh://git@10.0.1.12/tools/sync_music.git
            basedir: sources
            branches:
                - origin/${gitlabSourceBranch}
            merge:
                branch: ${gitlabTargetBranch}
            browser: gitlab
            browser-url: http://10.0.1.12/tools/sync_music

- scm:
    name: scm-github
    scm:
        - git:
            url: https://github.com/fetzerch/sync_music.git
            basedir: sources
            browser: githubweb
            browser-url: https://github.com/fetzerch/sync_music


# ----- Builder ---------------------------------------------------------------

- builder:
    name: build-tox
    builders:
        - shell: |
            #!/bin/bash -eu
            export PY_COLORS=1

            rm -rf $WORKSPACE/build
            mkdir $WORKSPACE/build
            cd $WORKSPACE/sources

            mdl $WORKSPACE/sources | tee $WORKSPACE/build/markdownlint.log

            tox -e flake8 | tee $WORKSPACE/build/flake8.log
            tox -e pylint | tee $WORKSPACE/build/pylint.log
            tox -e py35-cover -- \
                --with-xunit --xunit-file=$WORKSPACE/build/nosetests.xml \
                --cover-xml --cover-xml-file=$WORKSPACE/build/coverage.xml \
                | tee $WORKSPACE/build/py35-cover.log


# ----- Publisher -------------------------------------------------------------

- publisher:
    name: publish-default
    publishers:
        - archive:
            artifacts: 'build/*,tox/distshare/*'
            fingerprint: true
        - warnings:
            run-always: true
            workspace-file-scanners:
                - file-pattern: build/markdownlint.log
                  scanner: markdownlint
                - file-pattern: build/flake8.log
                  scanner: Pep8
                - file-pattern: build/pylint.log
                  scanner: PyLint
            total-thresholds:
                unstable:
                    total-all: 0
        - junit:
            results: build/nosetests.xml
            test-stability: true
        - cobertura:
            report-file: build/coverage.xml
            fail-no-reports: true
            targets:
                - files:
                    failing: 10000000
                - line:
                    failing: 10000000
                - conditional:
                    failing: 10000000


# ----- Parameter -------------------------------------------------------------

- parameter:
    name: gitlab-parameters
    parameters:
        - string:
            name: gitlabTargetBranch
            default: master
        - string:
            name: gitlabSourceBranch
            default: master
        - string:
            name: gitlabBranch
            default: master


# ----- Jobs ------------------------------------------------------------------

- job:
    name: sync_music
    parameters:
        - gitlab-parameters
    scm:
        - scm-git
    triggers:
        - gitlab
    builders:
        - build-tox
    publishers:
        - publish-default

- job:
    name: sync_music_github
    scm:
        - scm-github
    triggers:
        - github
    builders:
        - build-tox
    publishers:
        - publish-default
        - github-notifier
